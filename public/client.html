<!doctype html>
<html>
  <head>
    <title>끝말잇기의 짱, 끝짱</title>
    <style>
      #messages {
        position: fixed;
        bottom: 100px;
        list-style-type: none;
        margin: 0;
        padding: 0;
        width: 95%;
        height: 150px;
        overflow-x: hidden;
        overflow-y: auto;
      }
      #messages li {
        padding: 5px 10px;
      }
      #form {
        background: #000;
        padding: 3px;
        width: fit-content;
        position: fixed;
        bottom: 0;
      }
      #input {
        border: none;
        padding: 10px;
        width: 1000px;
      }
      #submit {
        width: 9%;
        background: rgb(130, 224, 255);
        border: none;
        padding: 10px;
      }
      #gameRoom {
        display: block;
        position: fixed;
        top: 0;
        width: 600px;
        height: 500px;
        background: rgb(100, 100, 100);
      }
    </style>
  </head>
  <body>
    <ul id="messages"></ul>
    <form id="form" action="">
      <input id="input" autocomplete="off" /><button id="submit">전송</button>
    </form>
    <!-- 방 만들기 버튼 추가 -->
    <button id="createGameRoomBtn" onclick="createGameRoom()">방 만들기</button>

    <h2>방 목록</h2>
    <div id="gameRoomList"></div>

    <div id="gameRoomContain"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket

      form.addEventListener('submit', (event) => {
        event.preventDefault()
        var input = document.getElementById('input')
        socket.emit('chat', input.value)
        input.value = ''
      })

      const leaveGameRoom = () => {
        socket.emit('leave game room')
        socket.disconnect()
        gameRoomContain.innerHTML = ''
        joinLobby()
      }

      const addGameRoomMember = (userInfo) => {
        var div = document.createElement('div')
        div.id = `user${userInfo.id}`
        div.innerHTML = userInfo.nickname
        member.appendChild(div)
      }

      const removeGameRoomMember = (userId) => {
        document.getElementById(`user${userId}`).remove()
      }

      const addChatEventListener = () => {
        socket.on('chat', (msg) => {
          var messages = document.getElementById('messages')
          var li = document.createElement('li')
          li.textContent = msg
          messages.appendChild(li)
          messages.scrollTop = messages.scrollHeight
        })
      }

      const addDrawGameRoomEventListener = () => {
        socket.on('draw game room', (gameRoomInfo) => {
          const roomInfoJson = JSON.parse(gameRoomInfo)
          // 방 그리기
          gameRoomContain.innerHTML = `
          <div id="gameRoom">
            <button onclick="leaveGameRoom()">나가기</button>
            <h2>${roomInfoJson.title}</h2>
            <div id="member">
            </div>
          </div>`

          // 현존 멤버들 그리기
          const roomMembers = roomInfoJson.members
          for (roomMember of roomMembers) {
            var div = document.createElement('div')
            div.id = `user${roomMember.id}`
            div.innerHTML = roomMember.nickname
            member.appendChild(div)
          }
        })
      }

      const addRefreshRoomEventListener = () => {
        socket.on('add game room member', (userInfo) => {
          addGameRoomMember(JSON.parse(userInfo))
        })
        socket.on('remove game room member', (userId) => {
          removeGameRoomMember(userId)
        })
      }

      const createGameRoom = () => {
        const title = prompt('방 제목을 입력해주세요')
        const password = prompt('비밀번호는 뭐죠')
        const memberLimit = prompt('인원수 제한은 몇명인가요')
        const roundCount = prompt('몇 라운드인가요')

        socket.disconnect()
        socket = io('http://localhost:3000/gameRoom')
        addChatEventListener()
        addRefreshRoomEventListener()
        addDrawGameRoomEventListener()

        socket.on('connect', () => {
          socket.emit('create game room', {
            title,
            password,
            memberLimit: Number(memberLimit),
            roundCount: Number(roundCount),
          })
        })
      }

      const joinLobby = () => {
        socket = io('http://localhost:3000/lobby')
        addChatEventListener()

        socket.on('fail join game room', (msg) => {
          alert(msg)
        })

        socket.on('success join game room', (roomId) => {
          socket.disconnect()
          socket = io('http://localhost:3000/gameRoom')
          addChatEventListener()
          addRefreshRoomEventListener()
          addDrawGameRoomEventListener()

          socket.on('connect', () => {
            socket.emit('join game room', roomId)
          })
        })

        socket.on('load game room', (gameRooms) => {
          var gameRoomList = document.getElementById('gameRoomList')
          gameRoomList.innerHTML = ''
          const gameRoomsJson = JSON.parse(gameRooms)
          for (const gameRoomId in gameRoomsJson) {
            var newGameRoom = document.createElement('div')
            const gameRoomInfo = gameRoomsJson[gameRoomId]

            if (gameRoomInfo.isPasswordRoom) {
              newGameRoom.setAttribute('data-isPasswordRoom', 'true')
            } else {
              newGameRoom.setAttribute('data-isPasswordRoom', 'false')
            }

            newGameRoom.id = gameRoomId
            newGameRoom.textContent = JSON.stringify(gameRoomInfo)

            gameRoomList.appendChild(newGameRoom)

            // 누르면 참가하기 이벤트 리스너 등록
            newGameRoom.addEventListener('click', function (event) {
              const roomId = event.target.id
              const joinTicket = {
                gameRoomId,
                password: '',
              }
              if (event.target.getAttribute('data-isPasswordRoom') === 'true') {
                const password = prompt('비밀번호를 입력해주세요')
                joinTicket.password = password
              }

              socket.emit('try join game room', joinTicket)
            })
          }
        })

        socket.on('new game room', (roomInfoWithId) => {
          var gameRoomList = document.getElementById('gameRoomList')
          var newGameRoom = document.createElement('div')
          const gameRoomWithIdJson = JSON.parse(roomInfoWithId)
          const { gameRoomId, gameRoomInfo } = gameRoomWithIdJson

          if (gameRoomInfo.isPasswordRoom) {
            newGameRoom.setAttribute('data-isPasswordRoom', 'true')
          } else {
            newGameRoom.setAttribute('data-isPasswordRoom', 'false')
          }

          newGameRoom.id = gameRoomId
          newGameRoom.textContent = JSON.stringify(gameRoomInfo)

          gameRoomList.appendChild(newGameRoom)

          // 누르면 참가하기 이벤트 리스너 등록
          newGameRoom.addEventListener('click', function (event) {
            const roomId = event.target.id
            const joinTicket = {
              gameRoomId,
              password: '',
            }
            if (event.target.getAttribute('data-isPasswordRoom') === 'true') {
              const password = prompt('비밀번호를 입력해주세요')
              joinTicket.password = password
            }

            socket.emit('try join game room', joinTicket)
          })
        })

        socket.on('refresh game room', (roomInfoWithId) => {
          const gameRoomWithIdJson = JSON.parse(roomInfoWithId)
          const { gameRoomId, gameRoomInfo } = gameRoomWithIdJson

          const targetGameRoom = document.getElementById(gameRoomId)
          targetGameRoom.textContent = JSON.stringify(gameRoomInfo)
        })

        socket.on('remove game room', (roomId) => {
          document.getElementById(roomId).remove()
        })
      }

      joinLobby()
    </script>
  </body>
</html>
